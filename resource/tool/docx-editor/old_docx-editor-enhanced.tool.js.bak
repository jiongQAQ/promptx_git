/**
 * DOCX Editor Enhanced - å¢å¼ºç‰ˆç½‘é¡µWordç¼–è¾‘å™¨ï¼ˆå®Œå–„æ ¼å¼å¯¼å‡ºï¼‰
 * 
 * æˆ˜ç•¥æ„ä¹‰ï¼š
 * 1. æ¶æ„ä»·å€¼ï¼šè§£å†³åŸç‰ˆæ ¼å¼ä¸¢å¤±é—®é¢˜ï¼Œæä¾›ç²¾ç¡®çš„æ ¼å¼è½¬æ¢
 * 2. å¹³å°ä»·å€¼ï¼šå®Œæ•´æ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼çš„docxå¯¼å‡ºï¼Œæ»¡è¶³ä¸“ä¸šæ–‡æ¡£éœ€æ±‚
 * 3. ç”Ÿæ€ä»·å€¼ï¼šä¸ºæ–‡æ¡£å¤„ç†æä¾›å¯é çš„æ ¼å¼ä¿æŒèƒ½åŠ›
 * 
 * è®¾è®¡ç†å¿µï¼š
 * é‡‡ç”¨ç²¾ç»†åŒ–HTMLè§£æå’Œdocxæ„å»ºï¼Œæ”¯æŒç²—ä½“ã€æ–œä½“ã€æ ‡é¢˜ã€åˆ—è¡¨ç­‰
 * å¸¸ç”¨æ ¼å¼çš„å‡†ç¡®è½¬æ¢ï¼Œç¡®ä¿å¯¼å‡ºæ–‡æ¡£ä¸ç¼–è¾‘å™¨æ˜¾ç¤ºæ•ˆæœä¸€è‡´ã€‚
 * 
 * ä¸ºä»€ä¹ˆé‡è¦ï¼š
 * è§£å†³äº†æ ¼å¼ä¸¢å¤±çš„å…³é”®é—®é¢˜ï¼Œè®©ç”¨æˆ·èƒ½å¤ŸçœŸæ­£å®ç°æ‰€è§å³æ‰€å¾—çš„
 * æ–‡æ¡£ç¼–è¾‘å’Œå¯¼å‡ºä½“éªŒã€‚
 */

module.exports = {
  getDependencies() {
    return {
      'express': '^4.18.2',
      'docx': '^8.5.0',
      'mammoth': '^1.6.0',
      'multer': '^1.4.5-lts.1',
      'cors': '^2.8.5',
      'uuid': '^9.0.1',
      'cheerio': '^1.0.0-rc.12'
    };
  },

  getMetadata() {
    return {
      id: 'docx-editor-enhanced',
      name: 'DOCX Editor Enhanced',
      description: 'å¢å¼ºç‰ˆç½‘é¡µWordç¼–è¾‘å™¨ï¼Œæ”¯æŒå®Œæ•´æ ¼å¼çš„docxå¯¼å‡º',
      version: '2.0.0',
      author: 'é²ç­'
    };
  },

  getSchema() {
    return {
      parameters: {
        type: 'object',
        properties: {
          action: {
            type: 'string',
            enum: ['start', 'stop', 'status'],
            description: 'æ“ä½œç±»å‹ï¼šstart-å¯åŠ¨ç¼–è¾‘å™¨ï¼Œstop-åœæ­¢æœåŠ¡ï¼Œstatus-æŸ¥çœ‹çŠ¶æ€',
            default: 'start'
          },
          port: {
            type: 'number',
            description: 'æœåŠ¡ç«¯å£å·',
            minimum: 3000,
            maximum: 65535,
            default: 3001
          }
        },
        required: ['action']
      }
    };
  },

  async execute(params) {
    const { api } = this;
    const { action = 'start', port = 3001 } = params;

    api.logger.info('å¢å¼ºç‰ˆDOCXç¼–è¾‘å™¨æ“ä½œ', { action, port });

    try {
      switch (action) {
        case 'start':
          return await this.startEditor(port);
        case 'stop':
          return await this.stopEditor();
        case 'status':
          return await this.getStatus();
        default:
          throw new Error(`æœªçŸ¥æ“ä½œ: ${action}`);
      }
    } catch (error) {
      api.logger.error('æ“ä½œå¤±è´¥', error);
      return {
        success: false,
        error: error.message,
        suggestion: 'è¯·æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨æˆ–é‡æ–°å¯åŠ¨æœåŠ¡'
      };
    }
  },

  async startEditor(port) {
    const { api } = this;
    
    // æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²è¿è¡Œ
    const status = await api.storage.getItem('enhanced_server_status');
    if (status && status.running) {
      return {
        success: true,
        message: 'å¢å¼ºç‰ˆç¼–è¾‘å™¨å·²åœ¨è¿è¡Œ',
        url: `http://localhost:${status.port}`,
        status: 'already_running'
      };
    }

    // åŠ è½½ä¾èµ–
    const express = await api.importx('express');
    const cors = await api.importx('cors');
    const multer = await api.importx('multer');

    // åˆ›å»ºExpressåº”ç”¨
    const app = express();
    app.use(cors());
    app.use(express.json({ limit: '50mb' }));
    app.use(express.urlencoded({ extended: true, limit: '50mb' }));

    // é…ç½®æ–‡ä»¶ä¸Šä¼ 
    const upload = multer({
      dest: '/tmp/',
      limits: { fileSize: 10 * 1024 * 1024 }
    });

    // é™æ€æ–‡ä»¶æœåŠ¡
    app.get('/', (req, res) => {
      res.send(this.getEnhancedEditorHTML());
    });

    app.get('/editor.js', (req, res) => {
      res.setHeader('Content-Type', 'application/javascript');
      res.send(this.getEnhancedEditorJS());
    });

    // APIè·¯ç”±
    app.post('/api/upload', upload.single('docx'), async (req, res) => {
      try {
        const result = await this.handleFileUpload(req.file);
        res.json(result);
      } catch (error) {
        res.status(500).json({ error: error.message });
      }
    });

    app.post('/api/export', async (req, res) => {
      try {
        const result = await this.handleEnhancedExport(req.body);
        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
        res.setHeader('Content-Disposition', 'attachment; filename="document.docx"');
        res.send(result);
      } catch (error) {
        api.logger.error('å¯¼å‡ºå¤±è´¥', error);
        res.status(500).json({ error: error.message });
      }
    });

    // å¯åŠ¨æœåŠ¡å™¨
    const server = app.listen(port, () => {
      api.logger.info(`å¢å¼ºç‰ˆDOCXç¼–è¾‘å™¨å·²å¯åŠ¨`, { port });
    });

    // ä¿å­˜æœåŠ¡çŠ¶æ€
    await api.storage.setItem('enhanced_server_status', {
      running: true,
      port: port,
      startTime: Date.now()
    });

    // ä¿å­˜æœåŠ¡å™¨å¼•ç”¨
    this.enhancedServer = server;

    return {
      success: true,
      message: 'å¢å¼ºç‰ˆDOCXç¼–è¾‘å™¨å¯åŠ¨æˆåŠŸ',
      url: `http://localhost:${port}`,
      features: [
        'âœ… å®Œæ•´æ ¼å¼å¯¼å‡ºæ”¯æŒ',
        'âœ… ç²—ä½“ã€æ–œä½“ã€ä¸‹åˆ’çº¿',
        'âœ… æ ‡é¢˜1-6çº§åˆ«',
        'âœ… æœ‰åºå’Œæ— åºåˆ—è¡¨',
        'âœ… æ–‡å­—é¢œè‰²å’ŒèƒŒæ™¯',
        'âœ… æ®µè½å¯¹é½æ–¹å¼'
      ],
      instructions: [
        '1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸Šè¿°URL',
        '2. ä½¿ç”¨å¯Œæ–‡æœ¬å·¥å…·æ ç¼–è¾‘æ–‡æ¡£',
        '3. ç‚¹å‡»å¯¼å‡ºæŒ‰é’®è·å¾—æ ¼å¼å®Œæ•´çš„docxæ–‡æ¡£',
        '4. æ”¯æŒä¸Šä¼ ç°æœ‰docxæ–‡ä»¶ç¼–è¾‘'
      ]
    };
  },

  async stopEditor() {
    const { api } = this;
    
    const status = await api.storage.getItem('enhanced_server_status');
    if (!status || !status.running) {
      return {
        success: true,
        message: 'å¢å¼ºç‰ˆç¼–è¾‘å™¨æœªåœ¨è¿è¡Œ',
        status: 'not_running'
      };
    }

    if (this.enhancedServer) {
      this.enhancedServer.close();
      this.enhancedServer = null;
    }

    await api.storage.setItem('enhanced_server_status', {
      running: false,
      stopTime: Date.now()
    });

    return {
      success: true,
      message: 'å¢å¼ºç‰ˆç¼–è¾‘å™¨å·²åœæ­¢'
    };
  },

  async getStatus() {
    const { api } = this;
    const status = await api.storage.getItem('enhanced_server_status');
    
    if (!status) {
      return {
        success: true,
        status: 'never_started',
        message: 'å¢å¼ºç‰ˆç¼–è¾‘å™¨ä»æœªå¯åŠ¨è¿‡'
      };
    }

    return {
      success: true,
      status: status.running ? 'running' : 'stopped',
      port: status.port,
      url: status.running ? `http://localhost:${status.port}` : null,
      startTime: status.startTime,
      stopTime: status.stopTime
    };
  },

  async handleFileUpload(file) {
    const { api } = this;
    
    if (!file) {
      throw new Error('æœªä¸Šä¼ æ–‡ä»¶');
    }

    const mammoth = await api.importx('mammoth');
    const fs = require('fs');

    // è¯»å–docxæ–‡ä»¶å¹¶è½¬æ¢ä¸ºHTML
    const result = await mammoth.convertToHtml({ path: file.path });
    
    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    fs.unlinkSync(file.path);

    return {
      success: true,
      html: result.value,
      messages: result.messages
    };
  },

  async handleEnhancedExport(data) {
    const { api } = this;
    
    try {
      const { Document, Paragraph, TextRun, Packer, HeadingLevel, AlignmentType } = await api.importx('docx');
      
      // è§£æHTMLå†…å®¹
      const paragraphs = await this.parseHtmlToDocxElements(data.html);
      
      // åˆ›å»ºæ–‡æ¡£
      const doc = new Document({
        sections: [{
          properties: {},
          children: paragraphs
        }]
      });

      // ç”Ÿæˆdocxæ–‡ä»¶
      return await Packer.toBuffer(doc);
      
    } catch (error) {
      api.logger.error('å¢å¼ºå¯¼å‡ºå¤±è´¥', error);
      throw new Error('æ–‡æ¡£å¯¼å‡ºå¤±è´¥: ' + error.message);
    }
  },

  async parseHtmlToDocxElements(html) {
    const { api } = this;
    const cheerio = await api.importx('cheerio');
    const { Paragraph, TextRun, HeadingLevel, AlignmentType } = await api.importx('docx');
    
    const $ = cheerio.load(html);
    const elements = [];
    
    // å¤„ç†æ¯ä¸ªæ®µè½å’Œå—çº§å…ƒç´ 
    $('p, h1, h2, h3, h4, h5, h6, ul, ol, li').each((index, element) => {
      const $el = $(element);
      const tagName = element.tagName.toLowerCase();
      
      if (tagName === 'p') {
        // å¤„ç†æ®µè½
        const paragraph = this.createParagraphFromElement($el, $);
        if (paragraph) elements.push(paragraph);
      } else if (tagName.match(/^h[1-6]$/)) {
        // å¤„ç†æ ‡é¢˜
        const heading = this.createHeadingFromElement($el, tagName, $);
        if (heading) elements.push(heading);
      } else if (tagName === 'li') {
        // å¤„ç†åˆ—è¡¨é¡¹
        const listItem = this.createListItemFromElement($el, $);
        if (listItem) elements.push(listItem);
      }
    });
    
    // å¦‚æœæ²¡æœ‰è§£æåˆ°å†…å®¹ï¼Œåˆ›å»ºé»˜è®¤æ®µè½
    if (elements.length === 0) {
      const text = $.text().trim();
      if (text) {
        elements.push(new Paragraph({
          children: [new TextRun(text)]
        }));
      }
    }
    
    return elements;
  },

  createParagraphFromElement($el, $) {
    const { Paragraph, TextRun, AlignmentType } = require('docx');
    
    const children = [];
    const alignment = this.getAlignment($el);
    
    // é€’å½’å¤„ç†æ®µè½å†…çš„æ–‡æœ¬å’Œæ ¼å¼
    this.processTextNodes($el, children, $);
    
    if (children.length === 0) {
      const text = $el.text().trim();
      if (text) {
        children.push(new TextRun(text));
      }
    }
    
    if (children.length > 0) {
      return new Paragraph({
        children: children,
        alignment: alignment
      });
    }
    
    return null;
  },

  createHeadingFromElement($el, tagName, $) {
    const { Paragraph, TextRun, HeadingLevel } = require('docx');
    
    const level = parseInt(tagName.charAt(1)) - 1; // h1=0, h2=1, ...
    const headingLevels = [
      HeadingLevel.HEADING_1,
      HeadingLevel.HEADING_2,
      HeadingLevel.HEADING_3,
      HeadingLevel.HEADING_4,
      HeadingLevel.HEADING_5,
      HeadingLevel.HEADING_6
    ];
    
    const children = [];
    this.processTextNodes($el, children, $);
    
    if (children.length === 0) {
      const text = $el.text().trim();
      if (text) {
        children.push(new TextRun(text));
      }
    }
    
    if (children.length > 0) {
      return new Paragraph({
        children: children,
        heading: headingLevels[level] || HeadingLevel.HEADING_1
      });
    }
    
    return null;
  },

  createListItemFromElement($el, $) {
    const { Paragraph, TextRun } = require('docx');
    
    const children = [];
    this.processTextNodes($el, children, $);
    
    if (children.length === 0) {
      const text = $el.text().trim();
      if (text) {
        children.push(new TextRun(text));
      }
    }
    
    if (children.length > 0) {
      return new Paragraph({
        children: children,
        bullet: {
          level: 0
        }
      });
    }
    
    return null;
  },

  processTextNodes($el, children, $) {
    const { TextRun } = require('docx');
    
    $el.contents().each((index, node) => {
      if (node.type === 'text') {
        const text = node.data.trim();
        if (text) {
          children.push(new TextRun(text));
        }
      } else if (node.type === 'tag') {
        const $node = $(node);
        const tagName = node.tagName.toLowerCase();
        const text = $node.text().trim();
        
        if (text) {
          const formatting = this.getTextFormatting($node);
          children.push(new TextRun({
            text: text,
            bold: formatting.bold,
            italics: formatting.italic,
            underline: formatting.underline ? {} : undefined,
            strike: formatting.strike,
            color: formatting.color,
            highlight: formatting.highlight
          }));
        }
      }
    });
  },

  getTextFormatting($el) {
    const style = $el.attr('style') || '';
    const classList = $el.attr('class') || '';
    
    return {
      bold: $el.is('strong, b') || style.includes('font-weight: bold') || classList.includes('ql-bold'),
      italic: $el.is('em, i') || style.includes('font-style: italic') || classList.includes('ql-italic'),
      underline: $el.is('u') || style.includes('text-decoration: underline') || classList.includes('ql-underline'),
      strike: $el.is('s, strike') || style.includes('text-decoration: line-through') || classList.includes('ql-strike'),
      color: this.extractColor(style),
      highlight: this.extractBackgroundColor(style)
    };
  },

  getAlignment($el) {
    const { AlignmentType } = require('docx');
    const style = $el.attr('style') || '';
    const classList = $el.attr('class') || '';
    
    if (style.includes('text-align: center') || classList.includes('ql-align-center')) {
      return AlignmentType.CENTER;
    } else if (style.includes('text-align: right') || classList.includes('ql-align-right')) {
      return AlignmentType.RIGHT;
    } else if (style.includes('text-align: justify') || classList.includes('ql-align-justify')) {
      return AlignmentType.JUSTIFIED;
    }
    
    return AlignmentType.LEFT;
  },

  extractColor(style) {
    const colorMatch = style.match(/color:\s*([^;]+)/);
    if (colorMatch) {
      return colorMatch[1].replace('#', '').toUpperCase();
    }
    return undefined;
  },

  extractBackgroundColor(style) {
    const bgMatch = style.match(/background-color:\s*([^;]+)/);
    if (bgMatch) {
      return bgMatch[1].replace('#', '').toUpperCase();
    }
    return undefined;
  },

  getEnhancedEditorHTML() {
    return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced DOCX Editor - å¢å¼ºç‰ˆç½‘é¡µWordç¼–è¾‘å™¨</title>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .header .version {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        .toolbar {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #229954;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-warning:hover {
            background: #e67e22;
        }
        .main-container {
            display: flex;
            height: calc(100vh - 160px);
            gap: 20px;
            padding: 20px;
        }
        .editor-container {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        #editor {
            height: 100%;
            border: none;
        }
        .sidebar {
            width: 280px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .status-bar {
            background: #34495e;
            color: white;
            padding: 10px 20px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        input[type="file"] {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 10px 18px;
            background: #3498db;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .file-label:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .stats {
            margin-top: 20px;
        }
        .stats h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        .stat-item {
            margin: 10px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }
        .feature-list {
            margin-top: 20px;
        }
        .feature-list h3 {
            margin: 0 0 15px 0;
            color: #27ae60;
            border-bottom: 2px solid #27ae60;
            padding-bottom: 5px;
        }
        .feature-list ul {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            margin: 8px 0;
            padding: 6px;
            background: #e8f5e8;
            border-radius: 4px;
            font-size: 12px;
        }
        .export-status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 500;
        }
        .export-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .export-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ Enhanced DOCX Editor</h1>
        <div class="version">å¢å¼ºç‰ˆ v2.0 - å®Œæ•´æ ¼å¼å¯¼å‡ºæ”¯æŒ</div>
    </div>
    
    <div class="toolbar">
        <label for="upload-input" class="file-label">
            ğŸ“‚ ä¸Šä¼ DOCX
        </label>
        <input type="file" id="upload-input" accept=".docx" />
        
        <button class="btn btn-success" onclick="exportDocument()">
            ğŸ’¾ å¯¼å‡ºDOCX
        </button>
        
        <button class="btn btn-primary" onclick="saveToLocal()">
            ğŸ’¿ æœ¬åœ°ä¿å­˜
        </button>
        
        <button class="btn btn-primary" onclick="loadFromLocal()">
            ğŸ“– æœ¬åœ°åŠ è½½
        </button>
        
        <button class="btn btn-warning" onclick="testFormats()">
            ğŸ§ª æµ‹è¯•æ ¼å¼
        </button>
    </div>
    
    <div class="main-container">
        <div class="editor-container">
            <div id="editor"></div>
        </div>
        
        <div class="sidebar">
            <h3>ğŸ“Š æ–‡æ¡£ç»Ÿè®¡</h3>
            <div class="stats">
                <div class="stat-item">
                    <span>å­—ç¬¦æ•°:</span>
                    <span id="char-count">0</span>
                </div>
                <div class="stat-item">
                    <span>å•è¯æ•°:</span>
                    <span id="word-count">0</span>
                </div>
                <div class="stat-item">
                    <span>æ®µè½æ•°:</span>
                    <span id="para-count">0</span>
                </div>
            </div>
            
            <div class="feature-list">
                <h3>âœ¨ å¢å¼ºåŠŸèƒ½</h3>
                <ul>
                    <li>âœ… ç²—ä½“ã€æ–œä½“ã€ä¸‹åˆ’çº¿</li>
                    <li>âœ… æ ‡é¢˜1-6çº§åˆ«</li>
                    <li>âœ… æœ‰åºå’Œæ— åºåˆ—è¡¨</li>
                    <li>âœ… æ–‡å­—é¢œè‰²å’ŒèƒŒæ™¯</li>
                    <li>âœ… æ®µè½å¯¹é½æ–¹å¼</li>
                    <li>âœ… å®Œæ•´æ ¼å¼å¯¼å‡º</li>
                </ul>
            </div>
            
            <div id="export-status" class="export-status" style="display: none;"></div>
        </div>
    </div>
    
    <div class="status-bar">
        <span id="status-message">å°±ç»ª</span>
        <span id="last-saved">æœªä¿å­˜</span>
    </div>
    
    <script src="/editor.js"></script>
</body>
</html>`;
  },

  getEnhancedEditorJS() {
    return `// Enhanced DOCX Editor JavaScript - å¢å¼ºç‰ˆ
let quill;
let autoSaveTimer;

// åˆå§‹åŒ–ç¼–è¾‘å™¨
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–Quillç¼–è¾‘å™¨
    quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'font': [] }, { 'size': [] }],
                [{ 'align': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                ['link', 'image', 'video'],
                ['clean']
            ]
        },
        placeholder: 'å¼€å§‹ç¼–å†™æ‚¨çš„æ–‡æ¡£...'
    });
    
    // ç›‘å¬å†…å®¹å˜åŒ–
    quill.on('text-change', function() {
        updateStats();
        scheduleAutoSave();
    });
    
    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    document.getElementById('upload-input').addEventListener('change', handleFileUpload);
    
    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†…å®¹
    loadFromLocal();
    
    // åˆå§‹ç»Ÿè®¡
    updateStats();
    
    showStatus('å¢å¼ºç‰ˆç¼–è¾‘å™¨å·²å°±ç»ªï¼Œæ”¯æŒå®Œæ•´æ ¼å¼å¯¼å‡º', 'success');
});

// å¤„ç†æ–‡ä»¶ä¸Šä¼ 
async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.name.endsWith('.docx')) {
        showStatus('è¯·é€‰æ‹©.docxæ ¼å¼çš„æ–‡ä»¶', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('docx', file);
    
    try {
        updateStatusMessage('æ­£åœ¨ä¸Šä¼ å’Œè§£ææ–‡ä»¶...');
        
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error('ä¸Šä¼ å¤±è´¥');
        }
        
        const result = await response.json();
        
        if (result.success) {
            quill.root.innerHTML = result.html;
            updateStats();
            showStatus('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ', 'success');
            updateStatusMessage('æ–‡ä»¶ä¸Šä¼ å®Œæˆ');
        } else {
            throw new Error(result.error);
        }
        
    } catch (error) {
        showStatus('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
        updateStatusMessage('ä¸Šä¼ å¤±è´¥');
    }
    
    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
    event.target.value = '';
}

// å¢å¼ºç‰ˆå¯¼å‡ºæ–‡æ¡£
async function exportDocument() {
    try {
        updateStatusMessage('æ­£åœ¨ç”ŸæˆDOCXæ–‡ä»¶...');
        showStatus('æ­£åœ¨å¯¼å‡ºï¼Œè¯·ç¨å€™...', 'success');
        
        const html = quill.root.innerHTML;
        
        console.log('å¯¼å‡ºHTMLå†…å®¹:', html); // è°ƒè¯•ç”¨
        
        const response = await fetch('/api/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ html: html })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error('å¯¼å‡ºå¤±è´¥: ' + errorText);
        }
        
        // ä¸‹è½½æ–‡ä»¶
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'enhanced_document_' + new Date().toISOString().slice(0, 10) + '.docx';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showStatus('âœ… DOCXæ–‡æ¡£å¯¼å‡ºæˆåŠŸï¼æ ¼å¼å·²å®Œæ•´ä¿ç•™', 'success');
        updateStatusMessage('å¯¼å‡ºæˆåŠŸ');
        
    } catch (error) {
        console.error('å¯¼å‡ºé”™è¯¯:', error);
        showStatus('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
        updateStatusMessage('å¯¼å‡ºå¤±è´¥');
    }
}

// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
function saveToLocal() {
    const content = quill.getContents();
    localStorage.setItem('enhanced-docx-editor-content', JSON.stringify(content));
    updateStatusMessage('å·²ä¿å­˜åˆ°æœ¬åœ°');
    updateLastSaved();
    showStatus('å†…å®¹å·²ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°', 'success');
}

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½
function loadFromLocal() {
    const saved = localStorage.getItem('enhanced-docx-editor-content');
    if (saved) {
        try {
            const content = JSON.parse(saved);
            quill.setContents(content);
            updateStatusMessage('å·²ä»æœ¬åœ°åŠ è½½');
        } catch (error) {
            console.error('åŠ è½½æœ¬åœ°å†…å®¹å¤±è´¥:', error);
        }
    }
}

// æµ‹è¯•æ ¼å¼åŠŸèƒ½
function testFormats() {
    const testContent = [
        { insert: 'æ ‡é¢˜1æµ‹è¯•', attributes: { header: 1 } },
        { insert: '\n' },
        { insert: 'æ ‡é¢˜2æµ‹è¯•', attributes: { header: 2 } },
        { insert: '\n' },
        { insert: 'è¿™æ˜¯' },
        { insert: 'ç²—ä½“', attributes: { bold: true } },
        { insert: 'æ–‡å­—ï¼Œè¿™æ˜¯' },
        { insert: 'æ–œä½“', attributes: { italic: true } },
        { insert: 'æ–‡å­—ï¼Œè¿™æ˜¯' },
        { insert: 'ä¸‹åˆ’çº¿', attributes: { underline: true } },
        { insert: 'æ–‡å­—ã€‚\n' },
        { insert: 'è¿™æ˜¯çº¢è‰²æ–‡å­—', attributes: { color: '#e60000' } },
        { insert: 'ï¼Œè¿™æ˜¯' },
        { insert: 'èƒŒæ™¯é«˜äº®', attributes: { background: '#ffff00' } },
        { insert: 'æ–‡å­—ã€‚\n' },
        { insert: 'æœ‰åºåˆ—è¡¨é¡¹1', attributes: { list: 'ordered' } },
        { insert: '\n' },
        { insert: 'æœ‰åºåˆ—è¡¨é¡¹2', attributes: { list: 'ordered' } },
        { insert: '\n' },
        { insert: 'æ— åºåˆ—è¡¨é¡¹1', attributes: { list: 'bullet' } },
        { insert: '\n' },
        { insert: 'æ— åºåˆ—è¡¨é¡¹2', attributes: { list: 'bullet' } },
        { insert: '\n' },
        { insert: 'å±…ä¸­å¯¹é½æ–‡å­—', attributes: { align: 'center' } },
        { insert: '\n' },
        { insert: 'å³å¯¹é½æ–‡å­—', attributes: { align: 'right' } },
        { insert: '\n' }
    ];
    
    quill.setContents(testContent);
    updateStats();
    showStatus('å·²æ’å…¥æ ¼å¼æµ‹è¯•å†…å®¹ï¼Œå¯ä»¥æµ‹è¯•å¯¼å‡ºæ•ˆæœ', 'success');
}

// è‡ªåŠ¨ä¿å­˜
function scheduleAutoSave() {
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }
    
    autoSaveTimer = setTimeout(() => {
        saveToLocal();
    }, 3000); // 3ç§’åè‡ªåŠ¨ä¿å­˜
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats() {
    const text = quill.getText();
    const html = quill.root.innerHTML;
    
    // å­—ç¬¦æ•°ï¼ˆä¸åŒ…æ‹¬ç©ºæ ¼ï¼‰
    const charCount = text.replace(/\s/g, '').length;
    
    // å•è¯æ•°
    const wordCount = text.trim().split(/\s+/).filter(word => word.length > 0).length;
    
    // æ®µè½æ•°
    const paraCount = (text.match(/\n/g) || []).length + 1;
    
    document.getElementById('char-count').textContent = charCount;
    document.getElementById('word-count').textContent = wordCount;
    document.getElementById('para-count').textContent = paraCount;
}

// æ›´æ–°çŠ¶æ€æ¶ˆæ¯
function updateStatusMessage(message) {
    document.getElementById('status-message').textContent = message;
    setTimeout(() => {
        document.getElementById('status-message').textContent = 'å°±ç»ª';
    }, 3000);
}

// æ˜¾ç¤ºå¯¼å‡ºçŠ¶æ€
function showStatus(message, type) {
    const statusEl = document.getElementById('export-status');
    statusEl.textContent = message;
    statusEl.className = 'export-status ' + type;
    statusEl.style.display = 'block';
    
    setTimeout(() => {
        statusEl.style.display = 'none';
    }, 5000);
}

// æ›´æ–°æœ€åä¿å­˜æ—¶é—´
function updateLastSaved() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    document.getElementById('last-saved').textContent = 'æœ€åä¿å­˜: ' + timeString;
}`;
  }
};