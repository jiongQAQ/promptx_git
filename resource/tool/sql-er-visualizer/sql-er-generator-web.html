<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL ERÂõæÁîüÊàêÂô® - Âú®Á∫øÂ∑•ÂÖ∑</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }
        
        .input-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 25px;
            display: flex;
            flex-direction: column;
        }
        
        .input-panel h2 {
            margin-bottom: 20px;
            color: #4a5568;
            font-size: 1.3rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }
        
        textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        select, input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: auto;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .generate-btn:active {
            transform: translateY(0);
        }
        
        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .output-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .output-header {
            background: #f8fafc;
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .output-header h2 {
            color: #4a5568;
            font-size: 1.3rem;
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            padding: 8px 16px;
            border: 1px solid #cbd5e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background: #f7fafc;
            border-color: #a0aec0;
        }
        
        #network {
            flex: 1;
            width: 100%;
            background: #fafafa;
        }
        
        .stats {
            background: #f8fafc;
            padding: 15px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #718096;
        }
        
        .example-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .example-btn:hover {
            background: #38a169;
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #feb2b2;
        }
        
        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #9ae6b4;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                height: auto;
            }
            
            .input-panel {
                margin-bottom: 20px;
            }
            
            #network {
                height: 500px;
            }
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #718096;
            font-size: 18px;
        }
        
        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóÇÔ∏è SQL ERÂõæÁîüÊàêÂô®</h1>
            <p>Â∞ÜMySQLÂª∫Ë°®ËØ≠Âè•ËΩ¨Êç¢‰∏∫‰∫§‰∫íÂºèERÂõæ - ÊîØÊåÅÊô∫ËÉΩÂÖ≥Á≥ªËØÜÂà´</p>
        </div>
        
        <div class="main-content">
            <div class="input-panel">
                <h2>üìù ËæìÂÖ•SQLËØ≠Âè•</h2>
                
                <button class="example-btn" onclick="loadExample()">üìÑ Âä†ËΩΩÁ§∫‰æãÊï∞ÊçÆ</button>
                
                <div id="message-area"></div>
                
                <div class="form-group">
                    <label for="sqlInput">MySQLÂª∫Ë°®ËØ≠Âè•:</label>
                    <textarea id="sqlInput" placeholder="ËØ∑ËæìÂÖ•CREATE TABLEËØ≠Âè•...\n\nÁ§∫‰æãÔºö\nCREATE TABLE users (\n    id BIGINT PRIMARY KEY AUTO_INCREMENT,\n    username VARCHAR(50) NOT NULL,\n    email VARCHAR(100) UNIQUE\n) ENGINE=InnoDB;\n\nCREATE TABLE posts (\n    id BIGINT PRIMARY KEY AUTO_INCREMENT,\n    user_id BIGINT NOT NULL,\n    title VARCHAR(200) NOT NULL,\n    content TEXT\n) ENGINE=InnoDB;"></textarea>
                </div>
                
                <div class="options">
                    <div class="form-group">
                        <label for="layout">Â∏ÉÂ±ÄÊñπÂºè:</label>
                        <select id="layout">
                            <option value="hierarchical">Â±ÇÊ¨°Â∏ÉÂ±Ä</option>
                            <option value="network">ÁΩëÁªúÂ∏ÉÂ±Ä</option>
                            <option value="circular">ÁéØÂΩ¢Â∏ÉÂ±Ä</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="theme">‰∏ªÈ¢ò:</label>
                        <select id="theme">
                            <option value="light">ÊµÖËâ≤‰∏ªÈ¢ò</option>
                            <option value="dark">Ê∑±Ëâ≤‰∏ªÈ¢ò</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="showFields" checked>
                            <label for="showFields">ÊòæÁ§∫Â≠óÊÆµËØ¶ÊÉÖ</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="showComments" checked>
                            <label for="showComments">ÊòæÁ§∫Ê≥®Èáä</label>
                        </div>
                    </div>
                </div>
                
                <button class="generate-btn" onclick="generateERDiagram()" id="generateBtn">
                    üöÄ ÁîüÊàêERÂõæ
                </button>
            </div>
            
            <div class="output-panel">
                <div class="output-header">
                    <h2>üìä ERÂõæÂèØËßÜÂåñ</h2>
                    <div class="controls">
                        <button class="control-btn" onclick="fitNetwork()" title="ÈÄÇÂ∫îÁîªÂ∏É">üéØ ÈÄÇÂ∫î</button>
                        <button class="control-btn" onclick="exportPNG()" title="ÂØºÂá∫ÂõæÁâá">üì∑ ÂØºÂá∫</button>
                        <button class="control-btn" onclick="togglePhysics()" title="ÂàáÊç¢Âä®Áîª">‚ö° Âä®Áîª</button>
                        <button class="control-btn" onclick="exportJSON()" title="ÂØºÂá∫Êï∞ÊçÆ">üíæ Êï∞ÊçÆ</button>
                    </div>
                </div>
                
                <div id="network">
                    <div class="loading">
                        <div>üëÜ ËØ∑Âú®Â∑¶‰æßËæìÂÖ•SQLËØ≠Âè•Âπ∂ÁÇπÂáªÁîüÊàêÊåâÈíÆ</div>
                    </div>
                </div>
                
                <div class="stats" id="stats" style="display: none;">
                    <span id="tableCount">Ë°®Êï∞Èáè: 0</span>
                    <span id="relationCount">ÂÖ≥Á≥ªÊï∞Èáè: 0</span>
                    <span id="fieldCount">Â≠óÊÆµÊï∞Èáè: 0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let network = null;
        let nodes = null;
        let edges = null;
        let physicsEnabled = false;
        let currentData = null;
        
        // Âä†ËΩΩÁ§∫‰æãÊï∞ÊçÆ
        function loadExample() {
            const exampleSQL = `-- Áî®Êà∑Ë°®
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'Áî®Êà∑ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'Áî®Êà∑Âêç',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT 'ÈÇÆÁÆ±',
    password VARCHAR(255) NOT NULL COMMENT 'ÂØÜÁ†Å',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'ÂàõÂª∫Êó∂Èó¥',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Êõ¥Êñ∞Êó∂Èó¥'
) ENGINE=InnoDB COMMENT='Áî®Êà∑Ë°®';

-- ÊñáÁ´†Ë°®
CREATE TABLE posts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ÊñáÁ´†ID',
    user_id BIGINT NOT NULL COMMENT '‰ΩúËÄÖID',
    title VARCHAR(200) NOT NULL COMMENT 'ÊñáÁ´†Ê†áÈ¢ò',
    content TEXT NOT NULL COMMENT 'ÊñáÁ´†ÂÜÖÂÆπ',
    status VARCHAR(20) DEFAULT 'draft' COMMENT 'Áä∂ÊÄÅ(draft/published)',
    view_count INT DEFAULT 0 COMMENT 'ÊµèËßàÊ¨°Êï∞',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'ÂàõÂª∫Êó∂Èó¥',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Êõ¥Êñ∞Êó∂Èó¥'
) ENGINE=InnoDB COMMENT='ÊñáÁ´†Ë°®';

-- ËØÑËÆ∫Ë°®
CREATE TABLE comments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ËØÑËÆ∫ID',
    post_id BIGINT NOT NULL COMMENT 'ÊñáÁ´†ID',
    user_id BIGINT NOT NULL COMMENT 'ËØÑËÆ∫ËÄÖID',
    content TEXT NOT NULL COMMENT 'ËØÑËÆ∫ÂÜÖÂÆπ',
    parent_id BIGINT COMMENT 'Áà∂ËØÑËÆ∫ID(ÂõûÂ§ç)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'ÂàõÂª∫Êó∂Èó¥'
) ENGINE=InnoDB COMMENT='ËØÑËÆ∫Ë°®';

-- Ê†áÁ≠æË°®
CREATE TABLE tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'Ê†áÁ≠æID',
    name VARCHAR(50) NOT NULL UNIQUE COMMENT 'Ê†áÁ≠æÂêçÁß∞',
    description VARCHAR(200) COMMENT 'Ê†áÁ≠æÊèèËø∞',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'ÂàõÂª∫Êó∂Èó¥'
) ENGINE=InnoDB COMMENT='Ê†áÁ≠æË°®';

-- ÊñáÁ´†Ê†áÁ≠æÂÖ≥ËÅîË°®
CREATE TABLE post_tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    post_id BIGINT NOT NULL COMMENT 'ÊñáÁ´†ID',
    tag_id BIGINT NOT NULL COMMENT 'Ê†áÁ≠æID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'ÂàõÂª∫Êó∂Èó¥',
    UNIQUE KEY uk_post_tag (post_id, tag_id)
) ENGINE=InnoDB COMMENT='ÊñáÁ´†Ê†áÁ≠æÂÖ≥ËÅîË°®';`;
            
            document.getElementById('sqlInput').value = exampleSQL;
            showMessage('Á§∫‰æãÊï∞ÊçÆÂ∑≤Âä†ËΩΩÔºåÁÇπÂáªÁîüÊàêÊåâÈíÆÊü•ÁúãERÂõæÔºÅ', 'success');
        }
        
        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const className = type === 'error' ? 'error-message' : 'success-message';
            messageArea.innerHTML = `<div class="${className}">${text}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }
        
        // ÁîüÊàêERÂõæ
        function generateERDiagram() {
            const sqlInput = document.getElementById('sqlInput').value.trim();
            if (!sqlInput) {
                showMessage('ËØ∑ÂÖàËæìÂÖ•SQLÂª∫Ë°®ËØ≠Âè•ÔºÅ', 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<div class="spinner"></div>Ê≠£Âú®ÁîüÊàê...';
            
            try {
                // Ëß£ÊûêSQL
                const tables = parseSQL(sqlInput);
                if (tables.length === 0) {
                    throw new Error('Êú™ÂèëÁé∞ÊúâÊïàÁöÑCREATE TABLEËØ≠Âè•');
                }
                
                // ËØÜÂà´ÂÖ≥Á≥ª
                const relations = extractRelations(tables);
                
                // ÁîüÊàêÂõæË°®
                renderERDiagram(tables, relations);
                
                // Êõ¥Êñ∞ÁªüËÆ°
                updateStats(tables, relations);
                
                // ‰øùÂ≠òÂΩìÂâçÊï∞ÊçÆ
                currentData = { tables, relations };
                
                showMessage(`ÊàêÂäüËß£Êûê ${tables.length} ‰∏™Ë°®ÔºåËØÜÂà´ ${relations.length} ‰∏™ÂÖ≥Á≥ªÔºÅ`, 'success');
                
            } catch (error) {
                console.error('ÁîüÊàêERÂõæÂ§±Ë¥•:', error);
                showMessage(`ÁîüÊàêÂ§±Ë¥•: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'üöÄ ÁîüÊàêERÂõæ';
            }
        }
        
        // Ëß£ÊûêSQLËØ≠Âè•
        function parseSQL(sql) {
            const tables = [];
            
            // ÂåπÈÖçCREATE TABLEËØ≠Âè•
            const tableRegex = /CREATE\s+TABLE\s+([`\w]+)\s*\((.*?)\)\s*(?:ENGINE\s*=\s*\w+)?(?:\s*DEFAULT\s+CHARSET\s*=\s*[\w\d_]+)?(?:\s*COLLATE\s*=\s*[\w\d_]+)?(?:\s*COMMENT\s*=\s*['"]([^'"]*)['"])?\s*;?/gis;
            let match;
            
            while ((match = tableRegex.exec(sql)) !== null) {
                const tableName = match[1].replace(/`/g, '');
                const tableBody = match[2];
                const tableComment = match[3] || '';
                
                const table = {
                    name: tableName,
                    comment: tableComment,
                    fields: [],
                    primaryKeys: [],
                    foreignKeys: []
                };
                
                // Ëß£ÊûêÂ≠óÊÆµÂíåÁ∫¶Êùü
                parseTableBody(tableBody, table);
                
                tables.push(table);
            }
            
            return tables;
        }
        
        // Ëß£ÊûêË°®‰Ωì
        function parseTableBody(tableBody, table) {
            // ÊåâÈÄóÂè∑ÂàÜÂâ≤Ôºå‰ΩÜË¶ÅËÄÉËôëÊã¨Âè∑ÂÜÖÁöÑÈÄóÂè∑
            const lines = splitTableLines(tableBody);
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;
                
                if (trimmedLine.toUpperCase().includes('PRIMARY KEY')) {
                    const pkMatch = trimmedLine.match(/PRIMARY\s+KEY\s*\(([^)]+)\)/i);
                    if (pkMatch) {
                        table.primaryKeys = pkMatch[1].split(',').map(k => k.trim().replace(/`/g, ''));
                    }
                } else if (trimmedLine.toUpperCase().includes('FOREIGN KEY')) {
                    const fkMatch = trimmedLine.match(/FOREIGN\s+KEY\s*\(([^)]+)\)\s*REFERENCES\s+([`\w]+)\s*\(([^)]+)\)/i);
                    if (fkMatch) {
                        table.foreignKeys.push({
                            field: fkMatch[1].trim().replace(/`/g, ''),
                            referencedTable: fkMatch[2].trim().replace(/`/g, ''),
                            referencedField: fkMatch[3].trim().replace(/`/g, '')
                        });
                    }
                } else if (trimmedLine.toUpperCase().includes('UNIQUE KEY') || 
                          trimmedLine.toUpperCase().includes('KEY ') ||
                          trimmedLine.toUpperCase().includes('INDEX ')) {
                    // Ë∑≥ËøáÁ¥¢ÂºïÂÆö‰πâ
                    continue;
                } else {
                    // Ëß£ÊûêÂ≠óÊÆµÂÆö‰πâ
                    const field = parseFieldDefinition(trimmedLine);
                    if (field) {
                        table.fields.push(field);
                    }
                }
            }
        }
        
        // Êô∫ËÉΩÂàÜÂâ≤Ë°®ÂÆö‰πâË°å
        function splitTableLines(tableBody) {
            const lines = [];
            let current = '';
            let parenthesesCount = 0;
            let inQuotes = false;
            let quoteChar = '';
            
            for (let i = 0; i < tableBody.length; i++) {
                const char = tableBody[i];
                
                if (!inQuotes && (char === '"' || char === "'")) {
                    inQuotes = true;
                    quoteChar = char;
                } else if (inQuotes && char === quoteChar) {
                    inQuotes = false;
                    quoteChar = '';
                }
                
                if (!inQuotes) {
                    if (char === '(') parenthesesCount++;
                    else if (char === ')') parenthesesCount--;
                    else if (char === ',' && parenthesesCount === 0) {
                        lines.push(current.trim());
                        current = '';
                        continue;
                    }
                }
                
                current += char;
            }
            
            if (current.trim()) {
                lines.push(current.trim());
            }
            
            return lines;
        }
        
        // Ëß£ÊûêÂ≠óÊÆµÂÆö‰πâ
        function parseFieldDefinition(line) {
            // ÂåπÈÖçÂ≠óÊÆµÂÆö‰πâ: field_name TYPE [constraints] [COMMENT 'xxx']
            const fieldMatch = line.match(/^([`\w]+)\s+([\w()]+)(.*)$/i);
            if (!fieldMatch) return null;
            
            const fieldName = fieldMatch[1].replace(/`/g, '');
            const fieldType = fieldMatch[2];
            const constraints = fieldMatch[3] || '';
            
            return {
                name: fieldName,
                type: fieldType,
                nullable: !constraints.toUpperCase().includes('NOT NULL'),
                autoIncrement: constraints.toUpperCase().includes('AUTO_INCREMENT'),
                unique: constraints.toUpperCase().includes('UNIQUE'),
                defaultValue: extractDefault(constraints),
                comment: extractFieldComment(constraints)
            };
        }
        
        // ÊèêÂèñÈªòËÆ§ÂÄº
        function extractDefault(constraints) {
            const defaultMatch = constraints.match(/DEFAULT\s+([^\s,]+)/i);
            if (defaultMatch) {
                let value = defaultMatch[1];
                if (value.startsWith("'") && value.endsWith("'")) {
                    value = value.slice(1, -1);
                }
                return value;
            }
            return null;
        }
        
        // ÊèêÂèñÂ≠óÊÆµÊ≥®Èáä
        function extractFieldComment(constraints) {
            const commentMatch = constraints.match(/COMMENT\s+['"]([^'"]*)['"]/);
            return commentMatch ? commentMatch[1] : '';
        }
        
        // ËØÜÂà´Ë°®ÂÖ≥Á≥ª
        function extractRelations(tables) {
            const relations = [];
            
            for (const table of tables) {
                // ÊòæÂºèÂ§ñÈîÆÂÖ≥Á≥ª
                for (const fk of table.foreignKeys) {
                    relations.push({
                        from: table.name,
                        to: fk.referencedTable,
                        fromField: fk.field,
                        toField: fk.referencedField,
                        type: 'many-to-one',
                        explicit: true
                    });
                }
                
                // Âü∫‰∫éÂëΩÂêçËßÑËåÉÁöÑÈöêÂºèÂÖ≥Á≥ª
                for (const field of table.fields) {
                    if (field.name.endsWith('_id') && field.name !== 'id') {
                        const baseName = field.name.replace('_id', '');
                        const possibleTableNames = [baseName + 's', baseName, baseName + 'es'];
                        
                        const referencedTable = tables.find(t => 
                            possibleTableNames.includes(t.name) || 
                            t.name === baseName
                        );
                        
                        if (referencedTable && !table.foreignKeys.some(fk => fk.field === field.name)) {
                            relations.push({
                                from: table.name,
                                to: referencedTable.name,
                                fromField: field.name,
                                toField: 'id',
                                type: 'many-to-one',
                                explicit: false
                            });
                        }
                    }
                }
            }
            
            return relations;
        }
        
        // Ê∏≤ÊüìERÂõæ
        function renderERDiagram(tables, relations) {
            const container = document.getElementById('network');
            const layout = document.getElementById('layout').value;
            const theme = document.getElementById('theme').value;
            const showFields = document.getElementById('showFields').checked;
            const showComments = document.getElementById('showComments').checked;
            
            // ÁîüÊàêËäÇÁÇπ
            const nodeData = tables.map(table => {
                let label = table.name;
                if (showComments && table.comment) {
                    label += `\n(${table.comment})`;
                }
                
                if (showFields && table.fields.length > 0) {
                    label += '\n\n';
                    const fieldLabels = table.fields.map(field => {
                        const isPK = table.primaryKeys.includes(field.name);
                        const isFK = table.foreignKeys.some(fk => fk.field === field.name);
                        const icon = isPK ? 'üîë' : (isFK ? 'üîó' : '‚óã');
                        
                        let fieldLabel = `${icon} ${field.name}: ${field.type}`;
                        if (showComments && field.comment) {
                            fieldLabel += ` // ${field.comment}`;
                        }
                        return fieldLabel;
                    });
                    label += fieldLabels.join('\n');
                }
                
                return {
                    id: table.name,
                    label: label,
                    color: {
                        background: theme === 'dark' ? '#2d3748' : '#ffffff',
                        border: theme === 'dark' ? '#4a5568' : '#cbd5e0'
                    },
                    font: {
                        color: theme === 'dark' ? '#f7fafc' : '#2d3748',
                        size: 12,
                        multi: true
                    },
                    shape: 'box',
                    margin: 15,
                    borderWidth: 2
                };
            });
            
            // ÁîüÊàêËæπ
            const edgeData = relations.map((rel, index) => ({
                id: index,
                from: rel.from,
                to: rel.to,
                label: `${rel.fromField} ‚Üí ${rel.toField}`,
                arrows: { to: { enabled: true, scaleFactor: 1.2 } },
                color: {
                    color: rel.explicit ? '#3182ce' : '#718096'
                },
                dashes: !rel.explicit,
                font: {
                    size: 10,
                    color: theme === 'dark' ? '#a0aec0' : '#4a5568'
                },
                width: rel.explicit ? 2 : 1
            }));
            
            nodes = new vis.DataSet(nodeData);
            edges = new vis.DataSet(edgeData);
            
            const data = { nodes: nodes, edges: edges };
            
            const options = {
                layout: {
                    hierarchical: layout === 'hierarchical' ? {
                        direction: 'UD',
                        sortMethod: 'directed',
                        nodeSpacing: 200,
                        levelSeparation: 200
                    } : false
                },
                physics: {
                    enabled: layout !== 'hierarchical',
                    stabilization: { iterations: 100 },
                    barnesHut: {
                        gravitationalConstant: -8000,
                        springLength: 200,
                        springConstant: 0.05
                    }
                },
                nodes: {
                    shape: 'box',
                    margin: 15,
                    font: {
                        multi: true,
                        bold: { color: theme === 'dark' ? '#f7fafc' : '#2d3748' }
                    },
                    borderWidth: 2,
                    borderWidthSelected: 3
                },
                edges: {
                    arrows: { to: { enabled: true, scaleFactor: 1.2 } },
                    smooth: { type: 'curvedCW', roundness: 0.2 },
                    width: 2
                },
                interaction: {
                    dragNodes: true,
                    dragView: true,
                    zoomView: true,
                    selectConnectedEdges: false
                },
                configure: {
                    enabled: false
                }
            };
            
            // ÁâπÊÆäÂ∏ÉÂ±ÄÂ§ÑÁêÜ
            if (layout === 'circular') {
                options.layout = {
                    randomSeed: 2
                };
                options.physics.enabled = true;
            }
            
            network = new vis.Network(container, data, options);
            physicsEnabled = layout !== 'hierarchical';
            
            // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    console.log('ÁÇπÂáª‰∫ÜË°®:', nodeId);
                    
                    // È´ò‰∫ÆÁõ∏ÂÖ≥ÁöÑËæπ
                    const connectedEdges = network.getConnectedEdges(nodeId);
                    network.selectEdges(connectedEdges);
                }
            });
            
            // ÂàùÂßãÂåñÂÆåÊàêÂêéÈÄÇÂ∫îÁîªÂ∏É
            setTimeout(() => {
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutCubic'
                    }
                });
            }, 500);
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats(tables, relations) {
            const totalFields = tables.reduce((sum, table) => sum + table.fields.length, 0);
            
            document.getElementById('tableCount').textContent = `Ë°®Êï∞Èáè: ${tables.length}`;
            document.getElementById('relationCount').textContent = `ÂÖ≥Á≥ªÊï∞Èáè: ${relations.length}`;
            document.getElementById('fieldCount').textContent = `Â≠óÊÆµÊï∞Èáè: ${totalFields}`;
            document.getElementById('stats').style.display = 'flex';
        }
        
        // ÊéßÂà∂ÂäüËÉΩ
        function fitNetwork() {
            if (network) {
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutCubic'
                    }
                });
            }
        }
        
        function exportPNG() {
            if (network) {
                const canvas = network.getCanvas();
                const link = document.createElement('a');
                link.download = 'er-diagram.png';
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                showMessage('ÂõæÁâáÂ∑≤ÂØºÂá∫ÔºÅ', 'success');
            }
        }
        
        function togglePhysics() {
            if (network) {
                physicsEnabled = !physicsEnabled;
                network.setOptions({ physics: { enabled: physicsEnabled } });
                showMessage(`Áâ©ÁêÜÊïàÊûúÂ∑≤${physicsEnabled ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}ÔºÅ`, 'success');
            }
        }
        
        function exportJSON() {
            if (currentData) {
                const dataStr = JSON.stringify(currentData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const link = document.createElement('a');
                link.download = 'er-diagram-data.json';
                link.href = URL.createObjectURL(blob);
                link.click();
                showMessage('Êï∞ÊçÆÂ∑≤ÂØºÂá∫‰∏∫JSONÔºÅ', 'success');
            }
        }
        
        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        generateERDiagram();
                        break;
                    case 's':
                        e.preventDefault();
                        exportPNG();
                        break;
                }
            }
        });
        
        // ÂàùÂßãÂåñÊèêÁ§∫
        console.log('SQL ERÂõæÁîüÊàêÂô®Â∑≤Âä†ËΩΩ');
        console.log('Âø´Êç∑ÈîÆ: Ctrl+Enter ÁîüÊàêÂõæË°®, Ctrl+S ÂØºÂá∫ÂõæÁâá');
    </script>
</body>
</html>